{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script>
        let map, service, infoWindow;

        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        infoWindow.setPosition(pos);
                        infoWindow.setContent("You are here");
                        infoWindow.open(map);
                        map.setCenter(pos);
                    },
                    () => {
                        handleLocationError(true, infoWindow, map.getCenter());
                    }
                );
            } else {
                handleLocationError(false, infoWindow, map.getCenter());
            }
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 27.2621, lng: -80.3835 },
                zoom: 6,
            });
            var request = {
                location: map.getCenter(),
                radius: '1500',
                type: ['food']
            };
            service = new google.maps.places.PlacesService(map);
            service.nearbySearch(request, callback);
            infoWindow = new google.maps.InfoWindow();
        }
        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(
                browserHasGeolocation
                    ? "Error: The Geolocation service failed."
                    : "Error: Your browser doesn't support geolocation."
            );
            infoWindow.open(map);
        }
        function callback(results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                for (var i = 0; i < results.length; i++) {
                    var marker = new google.maps.Marker({
                        position: results[i].geometry.location,
                    });
                    new google.maps.Marker(map.getCenter());
                    marker.setMap(map);
                }
            }
        }
    </script>
    {% comment %} <script
        src=`"https://maps.googleapis.com/maps/api/place/nearbysearch/json?location="{{ map.getCenter }}"&radius=1500&type=dog+park&keyword=dog+park&key=AIzaSyC0oMrMT02Hmgb1IbcvZrE1Cx7K_m75sZI"`>
    </script> {% endcomment %}
    <title>Puppub</title>
</head>
<body>
    <header>
        <h1 id="title">Pup Pub</h1>
    </header>
    <main>
        {% if user.is_authenticated %}
        <h2>Welcome {{ user.username }}!</h2>
        <p><a href="{% url 'logout' %}">Logout</a><p>
        {% else %}
        <h2>Welcome, Human!</h2>
        <p>You are not logged in. <a href="{% url 'login' %}">Login</a> <a href="{% url 'users:signup' %}">Sign Up</a></p>
        {% endif %}
        <div id="map"></div>
        <script
            src="https://maps.googleapis.com/maps/api/js?key=&libraries=places&callback=initMap" async>
        </script>
    </main>
    <footer>
    </footer>
</body>
</html>
